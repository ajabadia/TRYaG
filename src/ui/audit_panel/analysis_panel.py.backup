# path: src/ui/audit_panel/analysis_panel.py
# Creado: 2025-11-21
# Última modificación: 2025-11-21
"""
Módulo para la visualización de la pestaña "Análisis Gráfico" del panel de auditoría.
"""
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import io
from utils.pdf_utils import PDF

def generate_pdf_analisis(df_analisis, filters_text):
    """Genera un PDF con los gráficos de análisis."""
    pdf = PDF()
    pdf.add_page()
    pdf.set_font('Arial', 'B', 12)
    pdf.cell(0, 10, 'Filtros Aplicados', ln=1)
    pdf.set_font('Arial', '', 10)
    for f_text in filters_text:
        pdf.multi_cell(0, 8, f_text, ln=1)
    pdf.ln(5)

    charts_to_generate = {
        "Evolucion_Triajes": "Evolución de Triajes por Día",
        "Distribucion_Niveles": "Distribución de Niveles (Decisión Humana)",
        "Comparativa_IA_Humano": "Comparativa IA vs. Humano",
        "Calidad_vs_Decision": "Calidad de Sugerencia vs. Decisión Final",
        "Dolor_por_Nivel": "Dolor Promedio por Nivel de Triaje"
    }

    for chart_key, title in charts_to_generate.items():
        pdf.set_font('Arial', 'B', 12)
        pdf.cell(0, 10, title, ln=1)

        fig, ax = plt.subplots()

        if chart_key == "Evolucion_Triajes":
            data = df_analisis.groupby(df_analisis['timestamp'].dt.date).size()
            data.plot(kind='line', ax=ax, marker='o', linestyle='-')
            ax.set_ylabel("Número de Triajes")
        elif chart_key == "Distribucion_Niveles":
            data = df_analisis['nivel_corregido'].value_counts()
            data.plot(kind='bar', ax=ax)
            ax.set_ylabel("Frecuencia")
        elif chart_key == "Comparativa_IA_Humano":
            ia_counts = df_analisis['sugerencia_ia'].value_counts().rename('Sugerencia IA')
            humano_counts = df_analisis['nivel_corregido'].value_counts().rename('Decisión Humana')
            data = pd.concat([ia_counts, humano_counts], axis=1).fillna(0).astype(int)
            data.plot(kind='bar', ax=ax)
            ax.set_ylabel("Frecuencia")
            ax.legend(title="Origen")
        elif chart_key == "Dolor_por_Nivel":
            data = df_analisis.groupby('nivel_corregido')['dolor'].mean().sort_values(ascending=False)
            data.plot(kind='bar', ax=ax, color='skyblue')
            ax.set_ylabel("Dolor Promedio (EVA)")
        elif chart_key == "Calidad_vs_Decision":
            # Usamos crosstab para crear una tabla de contingencia
            data = pd.crosstab(df_analisis['decision_humana'], df_analisis['calificacion_humana'])
            data.plot(kind='bar', ax=ax)
            ax.set_ylabel("Número de Casos")
        elif chart_key == "Calidad_Sugerencia_Pie":
            # Para el gráfico de tarta, usamos una versión apilada de los datos
            data = pd.crosstab(df_analisis['decision_humana'], df_analisis['calificacion_humana']).stack()
            ax.pie(data, labels=[f"{i[0]}-{i[1]}" for i in data.index], autopct='%1.1f%%', startangle=90)
            ax.set_ylabel("Número de Casos")

        ax.set_title(title)
        plt.xticks(rotation=45)
        fig.tight_layout()

        img_buffer = io.BytesIO()
        fig.savefig(img_buffer, format="png")
        img_buffer.seek(0)

        tasa_acierto = (aciertos / total_casos) * 100 if total_casos > 0 else 0
        
        # Nueva métrica: Tasa de Modificación
        modificaciones = (df_analisis['decision_humana'] == 'Modificar Nivel').sum()
        tasa_modificacion = (modificaciones / total_casos) * 100 if total_casos > 0 else 0

        nivel_frecuente = df_analisis['nivel_corregido'].mode()[0] if total_casos > 0 else "N/A"
        calificaciones_positivas = (df_analisis['calificacion_humana'] == 'Correcto').sum()
        tasa_calificacion_positiva = (calificaciones_positivas / total_casos) * 100 if total_casos > 0 else 0

        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric(label="Total de Triajes", value=total_casos)
        with col2:
            st.metric(label="Tasa de Acierto IA", value=f"{tasa_acierto:.1f}%", delta=f"{tasa_acierto-100:.1f}%" if tasa_acierto < 100 else None)
        with col3:
            st.metric(label="Tasa de Modificación", value=f"{tasa_modificacion:.1f}%", help="Porcentaje de casos donde el humano decidió modificar el nivel sugerido.")
        with col4:
            st.metric(label="Calificación Positiva", value=f"{tasa_calificacion_positiva:.1f}%")

    with tab_evolucion:
        st.markdown("#### Evolución de Triajes por Día")
        chart_type = st.radio("Tipo de Gráfico", ["Línea", "Área", "Barra"], key="chart_evolucion", horizontal=True)
        triajes_por_dia = df_analisis.groupby(df_analisis['timestamp'].dt.date).size()
        
        if chart_type == "Línea":
            st.line_chart(triajes_por_dia, use_container_width=True)
        elif chart_type == "Área":
            st.area_chart(triajes_por_dia, use_container_width=True)
        elif chart_type == "Barra":
            st.bar_chart(triajes_por_dia, use_container_width=True)

    with tab_distribucion:
        st.markdown("#### Distribución de Niveles de Triaje (Decisión Humana)")
        chart_type = st.radio("Tipo de Gráfico", ["Barra", "Circular (Donut)"], key="chart_distribucion", horizontal=True)
        nivel_counts = df_analisis['nivel_corregido'].value_counts()
        
        if chart_type == "Barra":
            st.bar_chart(nivel_counts, use_container_width=True, color="#28a745")
        elif chart_type == "Circular (Donut)":
            fig, ax = plt.subplots()
            ax.pie(nivel_counts, labels=nivel_counts.index, autopct='%1.1f%%', startangle=90, wedgeprops=dict(width=0.3))
            ax.axis('equal')
            st.pyplot(fig)
            plt.close(fig)

    with tab_comparativa:
        st.markdown("#### Comparativa: Sugerencia IA vs. Decisión Humana")
        chart_type = st.radio("Tipo de Gráfico", ["Barras Agrupadas", "Barras Apiladas", "Área"], key="chart_comparativa", horizontal=True)
        
        ia_counts = df_analisis['sugerencia_ia'].value_counts().rename('Sugerencia IA')
        humano_counts = df_analisis['nivel_corregido'].value_counts().rename('Decisión Humana')
        comparison_df = pd.concat([ia_counts, humano_counts], axis=1).fillna(0).astype(int)
        
        if chart_type == "Barras Agrupadas":
            st.bar_chart(comparison_df, use_container_width=True)
        elif chart_type == "Barras Apiladas":
            st.bar_chart(comparison_df, use_container_width=True, stack=True)
        elif chart_type == "Área":
            st.area_chart(comparison_df, use_container_width=True)

    with tab_dolor:
        st.markdown("#### Relación Dolor - Nivel de Triaje")
        chart_type = st.radio("Tipo de Gráfico", ["Barra (Promedio)", "Scatter (Dispersión)"], key="chart_dolor", horizontal=True)
        
        if chart_type == "Barra (Promedio)":
            dolor_por_nivel = df_analisis.groupby('nivel_corregido')['dolor'].mean().sort_values(ascending=False)
            st.bar_chart(dolor_por_nivel, use_container_width=True)
        elif chart_type == "Scatter (Dispersión)":
            st.scatter_chart(df_analisis, x='nivel_corregido', y='dolor', color='nivel_corregido', use_container_width=True)
        
        st.divider()
        st.markdown("#### Distribución de Edad y Dolor")
        c_hist1, c_hist2 = st.columns(2)
        with c_hist1:
            st.markdown("**Distribución de Edad**")
            st.bar_chart(df_analisis['edad'].value_counts().sort_index(), use_container_width=True)
        with c_hist2:
            st.markdown("**Distribución de Dolor (EVA)**")
            st.bar_chart(df_analisis['dolor'].value_counts().sort_index(), use_container_width=True)

    with tab_calidad:
        st.markdown("#### Calidad de la Sugerencia vs. Decisión Final")
        chart_type = st.radio("Tipo de Gráfico", ["Barras Apiladas", "Barras Agrupadas"], key="chart_calidad", horizontal=True)
        
        calidad_vs_decision_df = pd.crosstab(df_analisis['decision_humana'], df_analisis['calificacion_humana'])
        
        if chart_type == "Barras Apiladas":
            st.bar_chart(calidad_vs_decision_df, use_container_width=True, stack=True)
        elif chart_type == "Barras Agrupadas":
            st.bar_chart(calidad_vs_decision_df, use_container_width=True, stack=False)

    with tab_discrepancias:
        st.markdown("#### Análisis de Discrepancias")
        discrepancias_df = df_analisis[df_analisis['sugerencia_ia'] != df_analisis['nivel_corregido']]
        
        if not discrepancias_df.empty:
            st.warning(f"Se han encontrado {len(discrepancias_df)} casos con discrepancia entre la IA y la decisión humana.")
            
            col_chart, col_table = st.columns([1, 1])
            with col_chart:
                st.markdown("##### Frecuencia de Discrepancias por Nivel")
                chart_type_disc = st.radio("Tipo de Gráfico", ["Barras Agrupadas", "Barras Apiladas", "Área"], key="chart_discrepancias", horizontal=True)
                
                ia_errors = discrepancias_df['sugerencia_ia'].value_counts().rename("Sugerencia IA (Incorrecta)")
                human_corrections = discrepancias_df['nivel_corregido'].value_counts().rename("Corrección Humana")
                error_comparison_df = pd.concat([ia_errors, human_corrections], axis=1).fillna(0).astype(int)
                
                if chart_type_disc == "Barras Agrupadas":
                    st.bar_chart(error_comparison_df, use_container_width=True)
                elif chart_type_disc == "Barras Apiladas":
                    st.bar_chart(error_comparison_df, use_container_width=True, stack=True)
                elif chart_type_disc == "Área":
                    st.area_chart(error_comparison_df, use_container_width=True)

            with col_table:
                 st.markdown("##### Detalle de Casos")
                 st.dataframe(discrepancias_df[['timestamp', 'sugerencia_ia', 'nivel_corregido', 'justificacion_humana']], use_container_width=True, hide_index=True)

        else:
            st.success("✅ No se han encontrado discrepancias entre la IA y las decisiones humanas.")
            st.markdown('<div class="debug-footer">src/ui/audit_panel/analysis_panel.py.backup</div>', unsafe_allow_html=True)
