============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-7.4.3, pluggy-1.6.0 -- C:\Users\ajaba\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web
plugins: cov-4.1.0
collecting ... collected 32 items

tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_basic PASSED [  3%]
tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_with_vitals PASSED [  6%]
tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_contexto_critico PASSED [  9%]
tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_exclusion PASSED [ 12%]
tests/unit/repositories/test_roles_repo.py::test_initialize_defaults PASSED [ 15%]
tests/unit/repositories/test_roles_repo.py::test_get_role_by_code PASSED [ 18%]
tests/unit/repositories/test_roles_repo.py::test_create_role_success PASSED [ 21%]
tests/unit/repositories/test_roles_repo.py::test_create_role_duplicate PASSED [ 25%]
tests/unit/repositories/test_users_repo.py::test_create_user PASSED      [ 28%]
tests/unit/repositories/test_users_repo.py::test_get_by_username PASSED  [ 31%]
tests/unit/repositories/test_users_repo.py::test_get_users_by_role PASSED [ 34%]
tests/unit/services/test_notification_service.py::test_create_notification_in_app_only FAILED [ 37%]
tests/unit/services/test_notification_service.py::test_create_notification_with_email PASSED [ 40%]
tests/unit/services/test_notification_service.py::test_send_email_success FAILED [ 43%]
tests/unit/services/test_notification_service.py::test_send_webhook_success FAILED [ 46%]
tests/unit/services/test_patient_service.py::test_validar_dni PASSED     [ 50%]
tests/unit/services/test_patient_service.py::test_generar_codigo_paciente PASSED [ 53%]
tests/unit/services/test_patient_service.py::test_crear_paciente_success PASSED [ 56%]
tests/unit/services/test_patient_service.py::test_crear_paciente_duplicate_ss PASSED [ 59%]
tests/unit/services/test_patient_service.py::test_buscar_paciente_existente PASSED [ 62%]
tests/unit/services/test_permissions_service.py::test_has_permission_no_user PASSED [ 65%]
tests/unit/services/test_permissions_service.py::test_has_permission_superadmin PASSED [ 68%]
tests/unit/services/test_permissions_service.py::test_has_permission_specific_role PASSED [ 71%]
tests/unit/services/test_permissions_service.py::test_get_available_tabs PASSED [ 75%]
tests/unit/services/test_queue_manager.py::test_calculate_priority_score_levels PASSED [ 78%]
tests/unit/services/test_queue_manager.py::test_calculate_priority_score_wait_time PASSED [ 81%]
tests/unit/services/test_queue_manager.py::test_sort_queue PASSED        [ 84%]
tests/unit/services/test_queue_manager.py::test_get_wait_time_alert PASSED [ 87%]
tests/unit/services/test_staff_assignment.py::test_get_current_user_assignment_fixed_only PASSED [ 90%]
tests/unit/services/test_staff_assignment.py::test_get_current_user_assignment_shift_active PASSED [ 93%]
tests/unit/services/test_staff_assignment.py::test_get_current_user_assignment_shift_inactive PASSED [ 96%]
tests/unit/services/test_staff_assignment.py::test_validate_shift_assignment_conflict PASSED [100%]

================================== FAILURES ===================================
____________________ test_create_notification_in_app_only _____________________

mock_db_notifications = Collection(Database(mongomock.MongoClient('localhost', 27017), 'db'), 'notifications')

    def test_create_notification_in_app_only(mock_db_notifications):
        notif_id = create_notification(
            title="Test",
            message="Hello",
            channels=[NotificationChannel.IN_APP]
        )
    
        assert notif_id is not None
    
        # Verify document structure
>       doc = mock_db_notifications.find_one({"_id": ObjectId(notif_id)})
E       NameError: name 'ObjectId' is not defined

tests\unit\services\test_notification_service.py:26: NameError
___________________________ test_send_email_success ___________________________

mock_get_config = <MagicMock name='get_smtp_config' id='2153691357136'>
mock_smtp = <MagicMock name='SMTP' id='2153669262848'>

    @patch('smtplib.SMTP')
    @patch('src.db.repositories.notification_config.get_smtp_config')
    def test_send_email_success(mock_get_config, mock_smtp):
        mock_get_config.return_value = {
            "enabled": True,
            "host": "smtp.test.com",
            "port": 587,
            "username": "user",
            "password": "pass",
            "from_email": "test@test.com"
        }
    
        notification = {
            "title": "Test Subject",
            "recipients": ["admin"],  # Will require get_recipient_emails mock if complex
        }
    
>       with patch('src.services.notification_service.get_recipient_emails', return_value=["admin@test.com"]):

tests\unit\services\test_notification_service.py:60: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:1497: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x000001F5709A0BB0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'src.services.notification_service' from 'C:\\Users\\ajaba\\Downloads\\master\\ftm\\piloto ABD\\nuevo\\web\\src\\services\\notification_service.py'> does not have the attribute 'get_recipient_emails'

C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:1467: AttributeError
__________________________ test_send_webhook_success __________________________

mock_get_config = <MagicMock name='get_webhook_config' id='2153691352096'>
mock_post = <MagicMock name='post' id='2153691351424'>

    @patch('requests.post')
    @patch('src.db.repositories.notification_config.get_webhook_config')
    def test_send_webhook_success(mock_get_config, mock_post):
        mock_get_config.return_value = {
            "enabled": True,
            "url": "http://webhook.com",
            "type": "slack"
        }
        mock_post.return_value.status_code = 200
    
        notification = {
            "title": "Webhook Test",
            "message": "Alert",
            "priority": "high"
        }
    
        success = _send_webhook(notification)
>       assert success == True
E       assert False == True

tests\unit\services\test_notification_service.py:82: AssertionError
---------------------------- Captured stdout call -----------------------------
Webhook no estß habilitado
============================== warnings summary ===============================
..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\mongomock\__version__.py:1
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\mongomock\__version__.py:1: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
    import pkg_resources

..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pkg_resources\__init__.py:3146
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\pkg_resources\__init__.py:3146: DeprecationWarning: Deprecated call to `pkg_resources.declare_namespace('google')`.
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(pkg)

src\db\models.py:36
src\db\models.py:36
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:36: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PromptVersion(BaseModel):

src\db\models.py:61
src\db\models.py:61
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:61: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AIAuditLog(BaseModel):

..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:942: 26 warnings
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:942: PydanticDeprecatedSince20: `__get_validators__` is deprecated and will be removed, use `__get_pydantic_core_schema__` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    warnings.warn(

..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:319: 50 warnings
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:319: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.12/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    warnings.warn(

src\db\models.py:96
src\db\models.py:96
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:96: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Prompt(BaseModel):

src\db\models.py:142
src\db\models.py:142
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:142: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class VitalSignReference(BaseModel):

src\db\models.py:194
src\db\models.py:194
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:194: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TriageRecord(BaseModel):

src\db\models.py:245
src\db\models.py:245
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:245: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FileImportRecord(BaseModel):

src\db\models.py:267
src\db\models.py:267
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:267: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TranscriptionRecord(BaseModel):

src\db\models.py:293
src\db\models.py:293
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:293: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PromptTest(BaseModel):

src\db\models.py:318
src\db\models.py:318
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:318: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ConfigItem(BaseModel):

src\db\models.py:353
src\db\models.py:353
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:353: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Person(BaseModel):

src\db\models.py:398
src\db\models.py:398
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:398: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PatientFlow(BaseModel):

src\db\models.py:433
src\db\models.py:433
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:433: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Turno(BaseModel):

src\db\models.py:456
src\db\models.py:456
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:456: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ClinicalOption(BaseModel):

src\db\models.py:476
src\db\models.py:476
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:476: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Sala(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/unit/services/test_notification_service.py::test_create_notification_in_app_only
FAILED tests/unit/services/test_notification_service.py::test_send_email_success
FAILED tests/unit/services/test_notification_service.py::test_send_webhook_success
================= 3 failed, 29 passed, 106 warnings in 5.39s ==================
