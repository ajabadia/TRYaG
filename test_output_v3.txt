============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-7.4.3, pluggy-1.6.0 -- C:\Users\ajaba\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web
plugins: cov-4.1.0
collecting ... collected 13 items

tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_basic PASSED [  7%]
tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_with_vitals PASSED [ 15%]
tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_contexto_critico PASSED [ 23%]
tests/unit/core/test_triage_logic.py::test_llamar_modelo_gemini_exclusion PASSED [ 30%]
tests/unit/services/test_patient_service.py::test_validar_dni PASSED     [ 38%]
tests/unit/services/test_patient_service.py::test_generar_codigo_paciente PASSED [ 46%]
tests/unit/services/test_patient_service.py::test_crear_paciente_success FAILED [ 53%]
tests/unit/services/test_patient_service.py::test_crear_paciente_duplicate_ss PASSED [ 61%]
tests/unit/services/test_patient_service.py::test_buscar_paciente_existente FAILED [ 69%]
tests/unit/services/test_staff_assignment.py::test_get_current_user_assignment_fixed_only PASSED [ 76%]
tests/unit/services/test_staff_assignment.py::test_get_current_user_assignment_shift_active PASSED [ 84%]
tests/unit/services/test_staff_assignment.py::test_get_current_user_assignment_shift_inactive PASSED [ 92%]
tests/unit/services/test_staff_assignment.py::test_validate_shift_assignment_conflict PASSED [100%]

================================== FAILURES ===================================
_________________________ test_crear_paciente_success _________________________

mock_db = Database(mongomock.MongoClient('localhost', 27017), 'db')

    def test_crear_paciente_success(mock_db):
        # No need to mock return_value, mongomock handles it
    
        person_data, warning = crear_paciente(
            nombre="Test",
            apellido1="User",
            apellido2=None,
            fecha_nacimiento=datetime(1990, 1, 1),
            num_ss="1111111111",
            num_identificacion="12345678Z",
            tipo_identificacion="DNI"
        )
    
        assert person_data["nombre"] == "Test"
        assert person_data["activo"] == True
        assert warning is None
    
        # Verify insertion in mock db
        saved_person = mock_db.people.find_one({"num_ss": "1111111111"})
>       assert saved_person is not None
E       assert None is not None

tests\unit\services\test_patient_service.py:49: AssertionError
_______________________ test_buscar_paciente_existente ________________________

mock_db = Database(mongomock.MongoClient('localhost', 27017), 'db')

    def test_buscar_paciente_existente(mock_db):
        # Insert patient to find
        mock_db.people.insert_one({
            "nombre": "Found",
            "num_ss": "123",
            "activo": True,
            "identificaciones": []
        })
    
        result = buscar_paciente_existente(num_ss="123")
>       assert result is not None
E       assert None is not None

tests\unit\services\test_patient_service.py:81: AssertionError
============================== warnings summary ===============================
..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\mongomock\__version__.py:1
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\mongomock\__version__.py:1: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
    import pkg_resources

..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pkg_resources\__init__.py:3146
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\pkg_resources\__init__.py:3146: DeprecationWarning: Deprecated call to `pkg_resources.declare_namespace('google')`.
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(pkg)

src\db\models.py:36
src\db\models.py:36
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:36: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PromptVersion(BaseModel):

src\db\models.py:61
src\db\models.py:61
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:61: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AIAuditLog(BaseModel):

..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:942: 26 warnings
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:942: PydanticDeprecatedSince20: `__get_validators__` is deprecated and will be removed, use `__get_pydantic_core_schema__` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    warnings.warn(

..\..\..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:319: 50 warnings
  C:\Users\ajaba\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:319: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.12/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    warnings.warn(

src\db\models.py:96
src\db\models.py:96
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:96: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Prompt(BaseModel):

src\db\models.py:142
src\db\models.py:142
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:142: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class VitalSignReference(BaseModel):

src\db\models.py:194
src\db\models.py:194
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:194: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TriageRecord(BaseModel):

src\db\models.py:245
src\db\models.py:245
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:245: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FileImportRecord(BaseModel):

src\db\models.py:267
src\db\models.py:267
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:267: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TranscriptionRecord(BaseModel):

src\db\models.py:293
src\db\models.py:293
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:293: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PromptTest(BaseModel):

src\db\models.py:318
src\db\models.py:318
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:318: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ConfigItem(BaseModel):

src\db\models.py:353
src\db\models.py:353
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:353: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Person(BaseModel):

src\db\models.py:398
src\db\models.py:398
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:398: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PatientFlow(BaseModel):

src\db\models.py:433
src\db\models.py:433
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:433: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Turno(BaseModel):

src\db\models.py:456
src\db\models.py:456
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:456: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ClinicalOption(BaseModel):

src\db\models.py:476
src\db\models.py:476
  C:\Users\ajaba\Downloads\master\ftm\piloto ABD\nuevo\web\src\db\models.py:476: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Sala(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/unit/services/test_patient_service.py::test_crear_paciente_success
FAILED tests/unit/services/test_patient_service.py::test_buscar_paciente_existente
================= 2 failed, 11 passed, 106 warnings in 6.17s ==================
